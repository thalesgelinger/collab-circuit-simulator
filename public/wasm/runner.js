var netlistGlobal;
var output = () => {};

function setValue(v) {
  const results = getValue();
  localStorage.setItem("simulation", JSON.stringify([...results, v]));
}

function getValue() {
  const resultString = localStorage.getItem("simulation");
  const results = resultString === null ? [] : JSON.parse(resultString);
  return results;
}

console.log("IS RUNNING RNUNER SCRIPT");

Module = {
  arguments: ["-b", "test.cir"],

  preRun: [
    () => {
      console.log("from html");
      FS.writeFile("/test.cir", netlistGlobal);
    },
  ],
  postRun: [
    () => {
      setValue("DONE");
    },
  ],
  print: (function () {
    return function (text) {
      if (arguments.length > 1)
        text = Array.prototype.slice.call(arguments).join(" ");
      setValue(text);
    };
  })(),
};

var runSpice = async (netlist, scriptPath) => {
  const delay = (time) => new Promise((res) => setTimeout(res, time));

  netlistGlobal = netlist;
  let results = getValue();

  const script = document.createElement("script");

  script.id = "spice";
  script.src = scriptPath;
  script.type = "text/javascript";
  document.body.appendChild(script);
  console.log("ADICIONOU o SCRIPT");

  const MAX_CALLS = 20;
  let maxCalls = 0;
  while (results[results.length - 1] !== "DONE" && maxCalls < MAX_CALLS) {
    results = getValue();
    await delay(200);
    maxCalls++;
  }

  const spice = document.getElementById("spice");
  spice?.remove();

  const resulstCopy = [...results];

  resetVars();

  localStorage.setItem("simulation", JSON.stringify([]));

  return resulstCopy;
};

function resetVars() {
  window.Module = undefined;
  window.netlistGlobal = undefined;
  window.moduleOverrides = undefined;
  window.arguments_ = undefined;
  window.thisProgram = undefined;
  window.quit_ = undefined;
  window.ENVIRONMENT_IS_WEB = undefined;
  window.ENVIRONMENT_IS_WORKER = undefined;
  window.ENVIRONMENT_IS_NODE = undefined;
  window.scriptDirectory = undefined;
  window.read_ = undefined;
  window.fs = undefined;
  window.nodePath = undefined;
  window.requireNodeFS = undefined;
  window.ret = undefined;
  window.xhr = undefined;
  window.xhr = undefined;
  window.xhr = undefined;
  window.out = undefined;
  window.err = undefined;
  window.POINTER_SIZE = undefined;
  window.typeNames = undefined;
  window.type = undefined;
  window.i = undefined;
  window.typeSection = undefined;
  window.sigRet = undefined;
  window.sigParam = undefined;
  window.typeCodes = undefined;
  window.i = undefined;
  window.bytes = undefined;
  window.module = undefined;
  window.instance = undefined;
  window.wrappedFunc = undefined;
  window.freeTableIndexes = undefined;
  window.functionsInTableMap = undefined;
  window.i = undefined;
  window.item = undefined;
  window.tempRet0 = undefined;
  window.setTempRet0 = undefined;
  window.getTempRet0 = undefined;
  window.wasmBinary = undefined;
  window.noExitRuntime = undefined;
  window.wasmMemory = undefined;
  window.ABORT = undefined;
  window.EXITSTATUS = undefined;
  window.func = undefined;
  window.toC = undefined;
  window.ret = undefined;
  window.len = undefined;
  window.ret = undefined;
  window.func = undefined;
  window.cArgs = undefined;
  window.stack = undefined;
  window.i = undefined;
  window.converter = undefined;
  window.ret = undefined;
  window.ALLOC_STACK = undefined;
  window.UTF8Decoder = undefined;
  window.endIdx = undefined;
  window.endPtr = undefined;
  window.str = undefined;
  window.u0 = undefined;
  window.u1 = undefined;
  window.u2 = undefined;
  window.ch = undefined;
  window.startIdx = undefined;
  window.endIdx = undefined;
  window.i = undefined;
  window.u = undefined;
  window.u1 = undefined;
  window.len = undefined;
  window.i = undefined;
  window.u = undefined;
  window.UTF16Decoder = undefined;
  window.size = undefined;
  window.ret = undefined;
  window.size = undefined;
  window.ret = undefined;
  window.i = undefined;
  window.buffer = undefined;
  window.INITIAL_MEMORY = undefined;
  window.wasmTable = undefined;
  window.__ATPRERUN__ = undefined;
  window.__ATINIT__ = undefined;
  window.__ATMAIN__ = undefined;
  window.__ATPOSTRUN__ = undefined;
  window.runtimeInitialized = undefined;
  window.runtimeExited = undefined;
  window.runtimeKeepaliveCounter = undefined;
  window.runDependencies = undefined;
  window.runDependencyWatcher = undefined;
  window.dependenciesFulfilled = undefined;
  window.callback = undefined;
  window.e = undefined;
  window.dataURIPrefix = undefined;
  window.wasmBinaryFile = undefined;
  window.info = undefined;
  window.exports = undefined;
  window.result = undefined;
  window.exports = undefined;
  window.tempDouble = undefined;
  window.tempI64 = undefined;
  window.callback = undefined;
  window.func = undefined;
  window.regex = undefined;
  window.y = undefined;
  window.wasmTableMirror = undefined;
  window.func = undefined;
  window.error = undefined;
  window._emscripten_get_now = undefined;
  window.t = undefined;
  window._emscripten_get_now_is_monotonic = undefined;
  window.now = undefined;
  window.value = undefined;
  window.prev = undefined;
  window.exceptionLast = undefined;
  window.uncaughtExceptionCount = undefined;
  window.info = undefined;
  window.PATH = undefined;
  window.splitPathRe = undefined;
  window.up = undefined;
  window.i = undefined;
  window.last = undefined;
  window.isAbsolute = undefined;
  window.result = undefined;
  window.lastSlash = undefined;
  window.paths = undefined;
  window.randomBuffer = undefined;
  window.crypto_module = undefined;
  window.PATH_FS = undefined;
  window.resolvedPath = undefined;
  window.i = undefined;
  window.path = undefined;
  window.start = undefined;
  window.end = undefined;
  window.fromParts = undefined;
  window.toParts = undefined;
  window.length = undefined;
  window.samePartsLength = undefined;
  window.i = undefined;
  window.outputParts = undefined;
  window.i = undefined;
  window.TTY = undefined;
  window.tty = undefined;
  window.bytesRead = undefined;
  window.i = undefined;
  window.result = undefined;
  window.i = undefined;
  window.result = undefined;
  window.BUFSIZE = undefined;
  window.buf = undefined;
  window.bytesRead = undefined;
  window.MEMFS = undefined;
  window.node = undefined;
  window.prevCapacity = undefined;
  window.CAPACITY_DOUBLING_MAX = undefined;
  window.oldContents = undefined;
  window.oldContents = undefined;
  window.attr = undefined;
  window.new_node = undefined;
  window.i = undefined;
  window.node = undefined;
  window.i = undefined;
  window.entries = undefined;
  window.key = undefined;
  window.node = undefined;
  window.contents = undefined;
  window.size = undefined;
  window.i = undefined;
  window.node = undefined;
  window.i = undefined;
  window.position = undefined;
  window.ptr = undefined;
  window.allocated = undefined;
  window.contents = undefined;
  window.bytesWritten = undefined;
  window.dep = undefined;
  window.FS = undefined;
  window.defaults = undefined;
  window.key = undefined;
  window.parts = undefined;
  window.current = undefined;
  window.current_path = undefined;
  window.i = undefined;
  window.islast = undefined;
  window.count = undefined;
  window.link = undefined;
  window.lookup = undefined;
  window.path = undefined;
  window.mount = undefined;
  window.hash = undefined;
  window.i = undefined;
  window.hash = undefined;
  window.hash = undefined;
  window.current = undefined;
  window.errCode = undefined;
  window.hash = undefined;
  window.node = undefined;
  window.nodeName = undefined;
  window.node = undefined;
  window.flags = undefined;
  window.perms = undefined;
  window.errCode = undefined;
  window.node = undefined;
  window.node = undefined;
  window.errCode = undefined;
  window.fd = undefined;
  window.fd = undefined;
  window.device = undefined;
  window.mounts = undefined;
  window.check = undefined;
  window.m = undefined;
  window.mounts = undefined;
  window.completed = undefined;
  window.root = undefined;
  window.pseudo = undefined;
  window.node = undefined;
  window.lookup = undefined;
  window.mount = undefined;
  window.mountRoot = undefined;
  window.lookup = undefined;
  window.node = undefined;
  window.mount = undefined;
  window.mounts = undefined;
  window.current = undefined;
  window.next = undefined;
  window.idx = undefined;
  window.lookup = undefined;
  window.parent = undefined;
  window.name = undefined;
  window.errCode = undefined;
  window.dirs = undefined;
  window.d = undefined;
  window.i = undefined;
  window.lookup = undefined;
  window.parent = undefined;
  window.newname = undefined;
  window.errCode = undefined;
  window.old_dirname = undefined;
  window.new_dirname = undefined;
  window.old_name = undefined;
  window.new_name = undefined;
  window.lookup = undefined;
  window.old_node = undefined;
  window.relative = undefined;
  window.new_node = undefined;
  window.isdir = undefined;
  window.errCode = undefined;
  window.lookup = undefined;
  window.parent = undefined;
  window.name = undefined;
  window.node = undefined;
  window.errCode = undefined;
  window.lookup = undefined;
  window.node = undefined;
  window.lookup = undefined;
  window.parent = undefined;
  window.name = undefined;
  window.node = undefined;
  window.errCode = undefined;
  window.lookup = undefined;
  window.link = undefined;
  window.lookup = undefined;
  window.node = undefined;
  window.node = undefined;
  window.lookup = undefined;
  window.stream = undefined;
  window.node = undefined;
  window.lookup = undefined;
  window.stream = undefined;
  window.node = undefined;
  window.lookup = undefined;
  window.errCode = undefined;
  window.stream = undefined;
  window.lookup = undefined;
  window.node = undefined;
  window.node = undefined;
  window.lookup = undefined;
  window.created = undefined;
  window.errCode = undefined;
  window.stream = undefined;
  window.seeking = undefined;
  window.bytesRead = undefined;
  window.seeking = undefined;
  window.bytesWritten = undefined;
  window.ret = undefined;
  window.stream = undefined;
  window.stat = undefined;
  window.length = undefined;
  window.buf = undefined;
  window.stream = undefined;
  window.buf = undefined;
  window.actualNumBytes = undefined;
  window.lookup = undefined;
  window.errCode = undefined;
  window.random_device = undefined;
  window.proc_self = undefined;
  window.node = undefined;
  window.fd = undefined;
  window.stream = undefined;
  window.ret = undefined;
  window.stdin = undefined;
  window.stdout = undefined;
  window.stderr = undefined;
  window.i = undefined;
  window.stream = undefined;
  window.mode = undefined;
  window.ret = undefined;
  window.lookup = undefined;
  window.ret = undefined;
  window.lookup = undefined;
  window.parts = undefined;
  window.part = undefined;
  window.current = undefined;
  window.path = undefined;
  window.mode = undefined;
  window.path = undefined;
  window.mode = undefined;
  window.node = undefined;
  window.arr = undefined;
  window.i = undefined;
  window.stream = undefined;
  window.path = undefined;
  window.mode = undefined;
  window.dev = undefined;
  window.bytesRead = undefined;
  window.i = undefined;
  window.result = undefined;
  window.i = undefined;
  window.chunkOffset = undefined;
  window.chunkNum = undefined;
  window.xhr = undefined;
  window.datalength = undefined;
  window.header = undefined;
  window.hasByteServing = undefined;
  window.usesGzip = undefined;
  window.chunkSize = undefined;
  window.doXHR = undefined;
  window.xhr = undefined;
  window.lazyArray = undefined;
  window.start = undefined;
  window.end = undefined;
  window.lazyArray = undefined;
  window.properties = undefined;
  window.properties = undefined;
  window.node = undefined;
  window.stream_ops = undefined;
  window.keys = undefined;
  window.fn = undefined;
  window.contents = undefined;
  window.size = undefined;
  window.i = undefined;
  window.i = undefined;
  window.fullname = undefined;
  window.dep = undefined;
  window.indexedDB = undefined;
  window.openRequest = undefined;
  window.db = undefined;
  window.db = undefined;
  window.transaction = undefined;
  window.files = undefined;
  window.ok = undefined;
  window.putRequest = undefined;
  window.indexedDB = undefined;
  window.openRequest = undefined;
  window.db = undefined;
  window.transaction = undefined;
  window.files = undefined;
  window.ok = undefined;
  window.getRequest = undefined;
  window.SYSCALLS = undefined;
  window.dir = undefined;
  window.dirstream = undefined;
  window.stat = undefined;
  window.buffer = undefined;
  window.ret = undefined;
  window.len = undefined;
  window.endChar = undefined;
  window.lookup = undefined;
  window.node = undefined;
  window.perms = undefined;
  window.suggest = undefined;
  window.ret = undefined;
  window.i = undefined;
  window.ptr = undefined;
  window.len = undefined;
  window.curr = undefined;
  window.ret = undefined;
  window.i = undefined;
  window.ptr = undefined;
  window.len = undefined;
  window.curr = undefined;
  window.ret = undefined;
  window.ret = undefined;
  window.stream = undefined;
  window.old = undefined;
  window.stream = undefined;
  window.arg = undefined;
  window.newStream = undefined;
  window.arg = undefined;
  window.arg = undefined;
  window.offset = undefined;
  window.stream = undefined;
  window.nofollow = undefined;
  window.allowEmpty = undefined;
  window.cwd = undefined;
  window.cwdLengthInBytes = undefined;
  window.stream = undefined;
  window.struct_size = undefined;
  window.pos = undefined;
  window.off = undefined;
  window.idx = undefined;
  window.id = undefined;
  window.type = undefined;
  window.name = undefined;
  window.lookup = undefined;
  window.child = undefined;
  window.stream = undefined;
  window.argp = undefined;
  window.argp = undefined;
  window.pathname = undefined;
  window.mode = undefined;
  window.stream = undefined;
  window.PIPEFS = undefined;
  window.pipe = undefined;
  window.rName = undefined;
  window.wName = undefined;
  window.rNode = undefined;
  window.wNode = undefined;
  window.readableStream = undefined;
  window.writableStream = undefined;
  window.pipe = undefined;
  window.i = undefined;
  window.bucket = undefined;
  window.pipe = undefined;
  window.currentLength = undefined;
  window.i = undefined;
  window.bucket = undefined;
  window.data = undefined;
  window.toRead = undefined;
  window.totalRead = undefined;
  window.toRemove = undefined;
  window.i = undefined;
  window.currBucket = undefined;
  window.bucketSize = undefined;
  window.tmpSlice = undefined;
  window.tmpSlice = undefined;
  window.pipe = undefined;
  window.data = undefined;
  window.dataLen = undefined;
  window.currBucket = undefined;
  window.freeBytesInCurrBuffer = undefined;
  window.numBuckets = undefined;
  window.remElements = undefined;
  window.i = undefined;
  window.newBucket = undefined;
  window.newBucket = undefined;
  window.pipe = undefined;
  window.res = undefined;
  window.date = undefined;
  window.start = undefined;
  window.yday = undefined;
  window.summerOffset = undefined;
  window.winterOffset = undefined;
  window.dst = undefined;
  window.currentYear = undefined;
  window.winter = undefined;
  window.summer = undefined;
  window.winterOffset = undefined;
  window.summerOffset = undefined;
  window.stdTimezoneOffset = undefined;
  window.match = undefined;
  window.winterName = undefined;
  window.summerName = undefined;
  window.winterNamePtr = undefined;
  window.summerNamePtr = undefined;
  window.oldSize = undefined;
  window.ENV = undefined;
  window.lang = undefined;
  window.env = undefined;
  window.x = undefined;
  window.strings = undefined;
  window.x = undefined;
  window.bufSize = undefined;
  window.ptr = undefined;
  window.strings = undefined;
  window.bufSize = undefined;
  window.stream = undefined;
  window.stream = undefined;
  window.type = undefined;
  window.stream = undefined;
  window.num = undefined;
  window.stream = undefined;
  window.HIGH_OFFSET = undefined;
  window.offset = undefined;
  window.DOUBLE_LIMIT = undefined;
  window.stream = undefined;
  window.num = undefined;
  window.millis = undefined;
  window.cmdstr = undefined;
  window.cp = undefined;
  window.ret = undefined;
  window._W_EXITCODE = undefined;
  window.signalToNumber = undefined;
  window.ret = undefined;
  window.FSNode = undefined;
  window.readMode = undefined;
  window.writeMode = undefined;
  window.ASSERTIONS = undefined;
  window.len = undefined;
  window.u8array = undefined;
  window.numBytesWritten = undefined;
  window.asmLibraryArg = undefined;
  window.asm = undefined;
  window.___wasm_call_ctors = undefined;
  window._main = undefined;
  window._malloc = undefined;
  window._saveSetjmp = undefined;
  window._free = undefined;
  window.___errno_location = undefined;
  window._setThrew = undefined;
  window.stackSave = undefined;
  window.stackRestore = undefined;
  window.stackAlloc = undefined;
  window.dynCall_jiji = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.sp = undefined;
  window.calledRun = undefined;
  window.calledMain = undefined;
  window.entryFunction = undefined;
  window.argc = undefined;
  window.argv = undefined;
  window.i = undefined;
  window.ret = undefined;
  window.run = undefined;
  window.shouldRunNow = undefined;
}
